<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Gate Scanner - {{machine.name}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            overflow: hidden;
        }

        #gate_app {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .header-bar {
            background: #ffffff;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 30;
            flex-direction: column;
            gap: 15px;
        }

        .header-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .header-title i {
            color: #1a237e;
            margin-right: 12px;
            font-size: 2rem;
        }

        .header-subtitle {
            font-size: 1.2rem;
            color: #666;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            background: #1a237e;
            color: white;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
        }

        .info-item.status-in {
            background: #28a745;
        }

        .info-item.status-out {
            background: #fd7e14;
        }

        .info-item.status-checkout {
            background: #dc3545;
        }

        .info-item.status-checkstatus {
            background: #6f42c1;
        }

        .info-item i {
            margin-right: 8px;
            font-size: 1.1rem;
        }

        .scanner-container {
            position: relative;
            height: calc(100vh - 120px);
            background: #ffffff;
            padding: 20px 30px 40px 30px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
        }

        #reader {
            width: calc(100% - 60px);
            height: calc(100% - 60px);
            max-width: 900px;
            max-height: 700px;
            position: relative;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .scanning-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 16;
            text-align: center;
        }

        .scan-text {
            font-size: 1.1rem;
            color: white;
            font-weight: 500;
        }

        .scan-line {
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #1a237e, transparent);
            animation: scan 2s ease-in-out infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes scan {
            0%, 100% { opacity: 0; transform: translateY(-30px); }
            50% { opacity: 1; transform: translateY(30px); }
        }

        @media (max-width: 768px) {
            .header-bar {
                padding: 15px;
                gap: 12px;
            }

            .header-info {
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .info-item {
                font-size: 0.9rem;
                padding: 8px 12px;
            }

            .scanner-container {
                height: calc(100vh - 140px);
                padding: 15px;
            }

            #reader {
                width: calc(100% - 30px);
                height: calc(100% - 30px);
            }

            .header-title {
                font-size: 1.4rem;
            }

            .header-title i {
                font-size: 1.6rem;
                margin-right: 10px;
            }

            .header-subtitle {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-bar {
                padding: 12px;
            }

            .header-info {
                flex-direction: column;
                gap: 10px;
            }

            .scanner-container {
                padding: 10px;
            }

            #reader {
                width: calc(100% - 20px);
                height: calc(100% - 20px);
            }

            .header-title {
                font-size: 1.2rem;
            }

            .header-title i {
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="gate_app">
        <div class="header-bar">
            <div class="header-center">
                <div class="header-title">
                    <i class="fas fa-qrcode"></i>
                    QR Gate Scanner
                </div>
                <div class="header-subtitle">ประตู: <span v-text="machine.name"></span></div>
            </div>

            <div class="header-info">
                <div class="info-item">
                    <i class="fas fa-building"></i>
                    <span v-text="machine.building_gate"></span>
                </div>
                <div class="info-item" :class="getStatusClass()">
                    <i :class="getStatusIcon()"></i>
                    <span v-text="getStatusDisplay()"></span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span v-text="currentTime"></span>
                </div>
            </div>
        </div>

        <div class="scanner-container">
            <div id="reader">
                <qrcode-stream 
                    @detect="detect" 
                    @init="onInit"
                    @error="onError"
                    style="width: 100%; height: 100%; object-fit: cover;">
                </qrcode-stream>

                <div class="scanning-indicator" v-if="status === 'scanning'">
                    <div class="scan-line"></div>
                    <div class="scan-text">วาง QR Code ตรงกล้อง</div>
                </div>
            </div>
        </div>
    </div>
	{{ include_script('frappe-web.bundle.js') }}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-qrcode-reader/dist/vue-qrcode-reader.umd.js"></script>

    <script>
        const { createApp } = Vue;

        const machine_data = {
            name: "{{machine.name}}",
            use_for: "{{machine.use_for}}", 
            building_gate: "{{machine.building_gate}}"
        }

        const app = createApp({
            delimiters: ["{!!", "!!}"],
            data() {
                return {
                    machine: machine_data,
                    currentTime: '',
                    status: 'scanning'
                }
            },
            methods: {
                async detect(detectedCodes) {
                    if (detectedCodes.length > 0 && this.status === 'scanning') {
                        const qrContent = detectedCodes[0].rawValue;
                        console.log('QR Code detected:', qrContent);

                        // Play sound
                        this.playSound();
                        
                        // Create Visitor Gate Pass record
                        this.createVisitorGatePass(qrContent);

                        // Brief pause before allowing next scan
                        this.status = 'processing';
                        setTimeout(() => {
                            this.status = 'scanning';
                        }, 1000);
                    }
                },

                playSound() {
                    try {
                        const audio = new Audio('/files/welcome.mp3');
                        audio.play().catch(e => {
                            console.log('MP3 not available, using beep');
                            this.playBeep();
                        });
                    } catch (e) {
                        this.playBeep();
                    }
                },

                playBeep() {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Audio not supported');
                    }
                },

                createVisitorGatePass(qrContent) {
                    frappe.call({
                        method: 'frappe.client.insert',
                        args: {
                            doc: {
                                doctype: 'Visitor Gate Pass',
                                visitor_register: qrContent,
                                gate_machine: this.machine.name,
                                building_gate: this.machine.building_gate,
                                building_name: this.machine.building_gate,
                                action_type: this.machine.use_for,
                                scan_datetime: frappe.datetime.now_datetime()
                            }
                        },
                        callback: (response) => {
                            console.log('Visitor Gate Pass created:', response.message.name);
                        },
                        error: (error) => {
                            console.error('Error creating record:', error);
                        }
                    });
                },

                onInit(promise) {
                    promise.then(() => {
                        console.log('Camera ready');
                        this.status = 'scanning';
                    }).catch((error) => {
                        console.error('Camera error:', error);
                    });
                },

                onError(error) {
                    console.error('Scanner error:', error);
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                },

                getStatusDisplay() {
                    const statusMap = {
                        'In': 'เข้า',
                        'Out': 'ออก', 
                        'CheckStatus': 'ตรวจสอบ',
                        'Checkout': 'ลงชื่อออก'
                    };
                    return statusMap[this.machine.use_for] || this.machine.use_for;
                },

                getStatusIcon() {
                    const iconMap = {
                        'In': 'fas fa-sign-in-alt',
                        'Out': 'fas fa-sign-out-alt',
                        'CheckStatus': 'fas fa-search',
                        'Checkout': 'fas fa-clock'
                    };
                    return iconMap[this.machine.use_for] || 'fas fa-qrcode';
                },

                getStatusClass() {
                    const classMap = {
                        'In': 'status-in',
                        'Out': 'status-out', 
                        'CheckStatus': 'status-checkstatus',
                        'Checkout': 'status-checkout'
                    };
                    return classMap[this.machine.use_for] || '';
                }
            },

            mounted() {
                this.updateTime();
                setInterval(this.updateTime, 1000);
            }
        });

        app.component('qrcode-stream', VueQrcodeReader.QrcodeStream);
        app.mount('#gate_app');
    </script>
</body>
</html>