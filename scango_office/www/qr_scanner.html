{% extends "templates/web.html" %}

{% block page_content %}
<div class="container mt-5">
    {% if error %}
    <!-- แสดงข้อผิดพลาด -->
    <div class="card border-danger">
        <div class="card-body text-center">
            <i class="fa fa-times-circle text-danger" style="font-size: 80px;"></i>
            <h2 class="text-danger mt-3">{{ error }}</h2>
            <p class="text-muted">{{ error_message }}</p>
        </div>
    </div>
    
    {% elif mode == "check_status" %}
    <!-- หน้าแสดงข้อมูล QR (CheckStatus) -->
    <div class="card">
        <div class="card-header bg-info text-white text-center">
            <h3 class="mb-0 text-white">
                <i class="fa fa-search"></i> ตรวจสอบสถานะ QR Code
            </h3>
        </div>
        <div class="card-body">
            <!-- แจ้งว่าบันทึกแล้ว -->
            {% if gate_pass_recorded %}
            <div class="alert alert-success mb-3">
                <i class="fa fa-check"></i> บันทึกการตรวจสอบเรียบร้อย
                <small class="d-block mt-1">เวลา: {{ gate_pass_time }}</small>
            </div>
            {% endif %}

            <!-- สถานะ -->
            <div class="alert alert-{{ status_color }} text-center mb-4">
                <h2 class="mb-0">
                    {% if status_color == "green" %}
                    <i class="fa fa-check-circle"></i>
                    {% elif status_color == "orange" %}
                    <i class="fa fa-clock"></i>
                    {% else %}
                    <i class="fa fa-times-circle"></i>
                    {% endif %}
                    {{ status }}
                </h2>
                <h4 class="mt-2">{{ days_text }}</h4>
            </div>

            <!-- ข้อมูลส่วนตัว -->
            <h5 class="border-bottom pb-2 mb-3">
                <i class="fa fa-user"></i> ข้อมูลส่วนตัว
            </h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>ชื่อ-นามสกุล:</strong><br>
                    {{ visitor.first_name }} {{ visitor.last_name or '' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>เบอร์โทรศัพท์:</strong><br>
                    {{ visitor.phone_number or '-' }}</p>
                </div>
            </div>

            <!-- วันที่เข้า-ออก -->
            <h5 class="border-bottom pb-2 mb-3 mt-4">
                <i class="fa fa-calendar"></i> ระยะเวลาเข้า-ออก
            </h5>
            <div class="row mb-3">
                <div class="col-md-4">
                    <p><strong>วันที่เข้า:</strong><br>
                    {{ frappe.utils.formatdate(visitor.visit_date, "dd/MM/yyyy") }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>วันที่ออก:</strong><br>
                    {{ frappe.utils.formatdate(visitor.visit_end_date, "dd/MM/yyyy") }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>จำนวนวัน:</strong><br>
                    {{ visitor.total_days or 0 }} วัน</p>
                </div>
            </div>

            <!-- วัตถุประสงค์ -->
            <h5 class="border-bottom pb-2 mb-3 mt-4">
                <i class="fa fa-info-circle"></i> วัตถุประสงค์
            </h5>
            <p>{{ visitor.purpose or '-' }}</p>
            {% if visitor.other_purpose_details %}
            <p class="text-muted">รายละเอียด: {{ visitor.other_purpose_details }}</p>
            {% endif %}

            <!-- ข้อมูลการสแกน -->
            <div class="text-muted small mt-4">
                <p><strong>ประตู:</strong> {{ machine.machine_id }} ({{ machine.building_gate }})</p>
                <p><strong>เวลาสแกน:</strong> {{ scan_time }}</p>
            </div>

            <!-- Countdown -->
            <div class="text-center mt-4">
                <p class="text-muted">กำลังกลับไปหน้า Gate ใน <span id="countdown">5</span> วินาที...</p>
            </div>
        </div>
    </div>

    <!-- Auto Redirect Script -->
    <script>
        let timeLeft = 10;
        const countdownElement = document.getElementById('countdown');
        const machineId = '{{ machine.name }}';
        
        const timer = setInterval(function() {
            timeLeft--;
            countdownElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                window.location.href = '/gate?name=' + machineId;
            }
        }, 1000);
    </script>
    
    {% elif mode == "gate_pass" %}
    <!-- Redirect ทันที หลังสแกน -->
    <script>
        const machineId = '{{ machine.name }}';
        window.location.href = '/gate?name=' + machineId;
    </script>
    {% endif %}
</div>

<style>
/* ซ่อน Navbar และ Footer */
.navbar,
.footer,
.page-head,
.page-breadcrumbs,
[class*="navbar"],
[class*="footer"] {
    display: none !important;
}

/* ปรับ Container ให้เต็มหน้าจอ */
.container {
    max-width: 100% !important;
    padding: 20px !important;
    margin: 0 !important;
}

body {
    margin: 0 !important;
    padding: 0 !important;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.alert {
    border-radius: 10px;
}

#countdown {
    font-weight: bold;
    color: #007bff;
    font-size: 1.2em;
}
</style>
{% endblock %}
